# Implementation Plan: 內部文件審核與簽核系統（Internal Document Review & Approval System）

**Branch**: `001-document-review-approval` | **Date**: 2026-02-02 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/001-document-review-approval/spec.md`

本計畫將 spec 的「嚴格狀態機 + 不可變版本/附件 + append-only 稽核/審核紀錄 + 物件層級授權（防 IDOR）+ 併發防重」落地為可實作的設計與契約，並提供 Phase 2 的實作拆解方向（由 `/speckit.tasks` 產出 tasks.md）。

## Summary

- 前端：React + TypeScript SPA，使用 React Router 做路由，TanStack Query 管理資料抓取與 mutation 防重，RHF+Zod 做表單與驗證，Tailwind 做 UI。
- 後端：Node.js + Fastify + TypeScript，REST/JSON，Zod 做輸入驗證；JWT session 存於 HttpOnly Cookie（寫入 API 需 CSRF 防護）。
- 儲存：SQLite 單檔 + Prisma；附件存檔案系統（不可覆寫，append-only）。
- 核心一致性：所有關鍵狀態變更（送審、同意/退回、封存、退回後修改）必須以單一 DB transaction 完成，並同交易寫入 AuditLog/ApprovalRecord。

已產出 Phase 0/1 的設計 artifacts：
- Research（決策與理由）：[research.md](research.md)
- Data model（概念模型與約束）：[data-model.md](data-model.md)
- API 契約（OpenAPI）：[contracts/openapi.yaml](contracts/openapi.yaml)
- Quickstart（最小可驗證流程）：[quickstart.md](quickstart.md)

## Technical Context

**Language/Version**: TypeScript 5.x（Node.js 20 LTS）+ React 18（TypeScript 5.x）
**Primary Dependencies**: Fastify、Prisma、Zod；React、React Router、TanStack Query、React Hook Form、Tailwind CSS
**Storage**: SQLite（單檔）+ Prisma Migrate；附件檔案系統（`storage/attachments/`）
**Testing**: Vitest、Playwright
**Target Platform**: macOS（開發）/ Linux server（部署）
**Project Type**: Web application（frontend + backend）
**Performance Goals**: 列表 2 秒內可互動；詳情 3 秒內可互動；審核動作 2 秒內回報結果
**Constraints**: SQLite 單檔；嚴格狀態機；append-only；物件層級授權（IDOR 防護）；ReviewTask 併發防重（409）
**Scale/Scope**: 內部系統（可成長），需支援多人同時審核且保持一致性

補充說明（供 Phase 2 實作時落地）：

- Backend: Fastify + TypeScript（Zod 驗證、Prisma 存取、交易為一致性邊界）
- Frontend: React Router + TanStack Query（統一 loading/error/empty/forbidden/not-found、mutation 防重）
- Auth: JWT session 存於 HttpOnly Cookie；所有寫入型 API 需 CSRF 防護
- Files: 附件採「不可覆寫」寫入策略（create-new），DB 僅保存 metadata + storage_key

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Required Gates (NON-NEGOTIABLE)**

- **Correctness & Consistency**: PASS
  - 狀態機與不變量在 spec 明確定義；Phase 1 資料模型與 DB constraints 對應落地（版本遞增、append-only、ReviewTask 一次性）。
- **Contracts**: PASS
  - 已產出 OpenAPI，並定義錯誤語意與安全模型（cookie + CSRF header）。
- **Rollback/Compensation**: PASS
  - 所有關鍵寫入採單一 transaction；任一子步驟（如任務建立、稽核寫入）失敗即整筆回滾，避免半成品。
- **Testing**: PASS（Phase 2 必須落地）
  - Phase 2 需用 Vitest/Playwright 覆蓋核心規則（狀態轉換、IDOR、一次性任務、append-only）。
- **Observability**: PASS
  - 統一錯誤 envelope（含 requestId）；關鍵事件寫入 AuditLog。
- **Security**: PASS
  - RBAC + object-level authz；Reviewer 的存在性隱藏（404）；寫入型 API 需 CSRF。
- **Performance/Scale**: PASS
  - SQLite WAL + busy timeout + 短交易策略（見 research）。
- **Compatibility**: PASS
  - 新系統；未來匯入/變更需遵守 append-only 與遷移/回滾策略（spec 已記載）。

## Project Structure

### Documentation (this feature)

```text
specs/001-document-review-approval/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   └── openapi.yaml
└── tasks.md             # Phase 2 output (/speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── api/             # Fastify routes + request validation
│   ├── auth/            # session + CSRF + RBAC helpers
│   ├── domain/          # state machine + invariants
│   ├── services/        # use-cases (transaction boundary)
│   ├── repositories/    # Prisma data access
│   ├── observability/   # requestId, logging, error mapping
│   └── server.ts
└── tests/

frontend/
├── src/
│   ├── routes/          # React Router
│   ├── pages/
│   ├── components/
│   ├── api/             # client wrappers + TanStack Query hooks
│   └── auth/
└── tests/

packages/
└── contracts/           # Zod schemas + TS types shared by FE/BE

storage/
└── attachments/
```

**Structure Decision**: Web application（frontend + backend + packages/contracts）。

## Phase 0: Outline & Research (DONE)

- Output: [research.md](research.md)
- 本 feature 的主要風險點（SQLite 併發、一次性任務、送審一致性、cookie+CSRF、附件不可覆寫、共享契約/錯誤格式）已被落地為可執行決策。

## Phase 1: Design & Contracts (DONE)

- Data model: [data-model.md](data-model.md)
- API contracts: [contracts/openapi.yaml](contracts/openapi.yaml)
- Quickstart: [quickstart.md](quickstart.md)

### Phase 1: Agent Context Update (NEXT ACTION)

執行 `.specify/scripts/bash/update-agent-context.sh copilot`，讓後續實作能讀到此 plan 的 tech stack 與專案型態。

### Constitution Re-check (post Phase 1)

- 結果：PASS
- 理由：契約（OpenAPI）與資料模型（constraints）已產出；主要一致性與安全風險均有明確設計；剩餘風險集中在 Phase 2 實作時是否能用交易/約束/測試落地。

## Phase 2: Implementation Planning (to be generated by /speckit.tasks)

以下為 tasks.md 應該拆解的核心里程碑與依賴（詳細任務由 `/speckit.tasks` 生成）：

1) **Foundation**
   - 建立 monorepo 結構（backend/frontend/packages/contracts/storage）
   - Prisma schema + migrations（含 constraints：unique、append-only、一次性任務）
   - 統一錯誤 envelope + requestId
   - Auth（JWT cookie + CSRF + RBAC + object-level authz）

2) **US1（P1）Draft → Submit → InReview**
   - Draft CRUD + 附件上傳（Draft-only）
   - 送審 transaction：鎖定版本 + 建立任務 + 稽核

3) **US2（P2）Reviewer approve/reject（409 併發防重）**
   - Task list + 任務處理
   - 一次性處理（條件式更新 + unique constraint）
   - reject 時取消其他 pending

4) **US3（P3）Flow templates + Archive**
   - 流程模板管理（含 step assignees）
   - Approved → Archived（Admin-only）

5) **Testing**
   - Vitest 覆蓋：狀態機、一次性任務、授權（含 Reviewer 404 隱藏存在性）、append-only、交易回滾
   - Playwright 覆蓋：三個 user stories 的端到端流程與全站 UX 狀態
