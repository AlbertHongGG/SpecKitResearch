generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  roles        Json     @default("[]")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  sessions           Session[]
  sellerProducts     Product[]           @relation("SellerProducts")
  orders             Order[]             @relation("BuyerOrders")
  auditLogs          AuditLog[]          @relation("ActorAuditLogs")
  sellerApplications SellerApplication[]

  cart            Cart?
  sellerSubOrders SubOrder[]      @relation("SellerSubOrders")
  refundRequests  RefundRequest[]
  reviews         Review[]
  settlements     Settlement[]

  @@map("users")
}

model Session {
  id         String    @id @default(cuid())
  tokenHash  String    @unique @map("token_hash")
  userId     String    @map("user_id")
  createdAt  DateTime  @default(now()) @map("created_at")
  expiresAt  DateTime  @map("expires_at")
  lastSeenAt DateTime? @map("last_seen_at")
  revokedAt  DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model SellerApplication {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  shopName          String   @map("shop_name")
  documents         Json?
  status            String
  reviewedByAdminId String?  @map("reviewed_by_admin_id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("seller_applications")
}

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  status    String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  products Product[]

  @@map("categories")
}

model Product {
  id          String   @id @default(cuid())
  sellerId    String   @map("seller_id")
  title       String
  description String
  price       Int
  stock       Int
  categoryId  String   @map("category_id")
  status      String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  seller   User     @relation("SellerProducts", fields: [sellerId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id])

  cartItems        CartItem[]
  subOrderItems    SubOrderItem[]
  reviews          Review[]
  inventoryLedgers InventoryLedger[]

  @@index([status, categoryId])
  @@index([sellerId, status])
  @@map("products")
}

model Cart {
  buyerId   String   @id @map("buyer_id")
  updatedAt DateTime @updatedAt @map("updated_at")

  items CartItem[]
  buyer User       @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@map("carts")
}

model CartItem {
  id        String @id @default(cuid())
  buyerId   String @map("buyer_id")
  productId String @map("product_id")
  quantity  Int

  cart    Cart    @relation(fields: [buyerId], references: [buyerId], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([buyerId, productId])
  @@index([buyerId])
  @@map("cart_items")
}

model Order {
  id          String   @id @default(cuid())
  buyerId     String   @map("buyer_id")
  totalAmount Int      @map("total_amount")
  status      String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  buyer            User              @relation("BuyerOrders", fields: [buyerId], references: [id], onDelete: Cascade)
  subOrders        SubOrder[]
  payments         Payment[]
  refunds          RefundRequest[]
  disputes         DisputeCase[]
  inventoryLedgers InventoryLedger[]

  @@index([buyerId])
  @@map("orders")
}

model SubOrder {
  id                        String   @id @default(cuid())
  orderId                   String   @map("order_id")
  sellerId                  String   @map("seller_id")
  subtotal                  Int
  status                    String
  refundRequestedPrevStatus String?  @map("refund_requested_prev_status")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  order    Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  seller   User            @relation("SellerSubOrders", fields: [sellerId], references: [id], onDelete: Cascade)
  items    SubOrderItem[]
  refunds  RefundRequest[]
  disputes DisputeCase[]

  @@index([orderId])
  @@index([sellerId, status])
  @@map("suborders")
}

model SubOrderItem {
  id                String @id @default(cuid())
  subOrderId        String @map("suborder_id")
  productId         String @map("product_id")
  unitPriceSnapshot Int    @map("unit_price_snapshot")
  quantity          Int

  subOrder SubOrder @relation(fields: [subOrderId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id])

  @@index([subOrderId])
  @@map("suborder_items")
}

model Payment {
  id                 String    @id @default(cuid())
  orderId            String    @map("order_id")
  paymentMethod      String    @map("payment_method")
  paymentStatus      String    @map("payment_status")
  transactionId      String    @map("transaction_id")
  callbackReceivedAt DateTime? @map("callback_received_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, transactionId])
  @@index([orderId])
  @@map("payments")
}

model RefundRequest {
  id                 String   @id @default(cuid())
  orderId            String   @map("order_id")
  subOrderId         String   @map("suborder_id")
  buyerId            String   @map("buyer_id")
  reason             String
  requestedAmount    Int      @map("requested_amount")
  approvedAmount     Int?     @map("approved_amount")
  status             String
  prevSubOrderStatus String?  @map("prev_suborder_status")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  subOrder SubOrder @relation(fields: [subOrderId], references: [id], onDelete: Cascade)
  buyer    User     @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([subOrderId, status])
  @@index([buyerId])
  @@map("refund_requests")
}

model Review {
  id        String   @id @default(cuid())
  buyerId   String   @map("buyer_id")
  productId String   @map("product_id")
  rating    Int
  comment   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  buyer   User    @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([buyerId, productId])
  @@index([productId])
  @@map("reviews")
}

model Settlement {
  id          String   @id @default(cuid())
  sellerId    String   @map("seller_id")
  period      String
  grossAmount Int      @map("gross_amount")
  platformFee Int      @map("platform_fee")
  netAmount   Int      @map("net_amount")
  status      String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  seller User @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@unique([sellerId, period])
  @@index([sellerId])
  @@map("settlements")
}

model DisputeCase {
  id             String   @id @default(cuid())
  orderId        String   @map("order_id")
  subOrderId     String?  @map("suborder_id")
  openedBy       String   @map("opened_by")
  status         String
  resolutionNote String?  @map("resolution_note")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  order    Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  subOrder SubOrder? @relation(fields: [subOrderId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([subOrderId])
  @@map("disputes")
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String   @map("actor_user_id")
  actorRole   String   @map("actor_role")
  action      String
  targetType  String   @map("target_type")
  targetId    String   @map("target_id")
  createdAt   DateTime @default(now()) @map("created_at")
  metadata    Json?

  actor User @relation("ActorAuditLogs", fields: [actorUserId], references: [id], onDelete: Cascade)

  @@index([targetType, targetId, createdAt])
  @@index([actorUserId, createdAt])
  @@map("audit_logs")
}

model WebhookEvent {
  id            String   @id @default(cuid())
  provider      String
  eventId       String   @map("event_id")
  orderId       String?  @map("order_id")
  transactionId String?  @map("transaction_id")
  payload       Json
  receivedAt    DateTime @default(now()) @map("received_at")

  @@unique([provider, eventId])
  @@index([orderId])
  @@index([transactionId])
  @@map("webhook_events")
}

model InventoryLedger {
  id            String   @id @default(cuid())
  productId     String   @map("product_id")
  orderId       String   @map("order_id")
  transactionId String   @map("transaction_id")
  quantity      Int
  createdAt     DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([productId, orderId, transactionId])
  @@index([productId])
  @@index([orderId])
  @@map("inventory_ledger")
}
